name: Build Universal Search

on: [push, workflow_dispatch]

jobs:
  build-win:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP 8.3
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, fileinfo, zip, curl, pdo, sqlite, pdo_sqlite, gd, intl, openssl

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Dependencies
      run: |
        composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist --ignore-platform-req=ext-fileinfo --ignore-platform-req=ext-zip
        npm ci && npm run build

    - name: Build Windows
      run: |
        copy .env.example .env
        php artisan key:generate
        # On ajoute -v pour voir les d√©tails si √ßa plante
        php artisan native:build win -v

    # C'EST ICI LA MAGIE : On cherche le .exe partout !
    - name: üîé FIND THE EXE (Recherche fichier)
      run: |
        echo "Recherche du fichier .exe sur tout le disque..."
        Get-ChildItem -Path . -Recurse -Filter *.exe | ForEach-Object { $_.FullName }

    # On essaie de r√©cup√©rer le fichier l√† o√π tu as dit qu'il √©tait
    - name: Upload Artifact (Backup Path)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: denasial-windows-found
        # On prend tout ce qui ressemble √† un setup.exe, o√π que ce soit
        path: '**/*.exe'